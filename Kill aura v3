-- LocalScript (StarterPlayerScripts)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- โหลด Humanoid
local function getHumanoid()
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    return char:WaitForChild("Humanoid")
end

-- โหลด Animation
local Animations = {
    Walk = Instance.new("Animation"),
    Idle = Instance.new("Animation"),
    Shoot = Instance.new("Animation")
}

Animations.Walk.AnimationId = "rbxassetid://133669151185294"
Animations.Idle.AnimationId = "rbxassetid://101810746304426"
Animations.Shoot.AnimationId = "rbxassetid://121573002971812"

-- สร้าง Animator
local humanoid = getHumanoid()
local Animator = humanoid:WaitForChild("Animator")

local walkTrack = Animator:LoadAnimation(Animations.Walk)
local idleTrack = Animator:LoadAnimation(Animations.Idle)
local shootTrack = Animator:LoadAnimation(Animations.Shoot)

-- ตัวแปรสถานะ
local isShooting = false

-- ตรวจจับเดิน/หยุด
local function updateAnim()
    if isShooting then return end -- ถ้ายิงอยู่ ไม่เปลี่ยนอนิเมชั่น

    if humanoid.MoveDirection.Magnitude > 0 then
        if not walkTrack.IsPlaying then
            idleTrack:Stop()
            walkTrack:Play()
        end
    else
        if not idleTrack.IsPlaying then
            walkTrack:Stop()
            idleTrack:Play()
        end
    end
end

humanoid.Running:Connect(function(speed)
    updateAnim()
end)

-- UI ยิง
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ยิงUI"
ScreenGui.Parent = game.CoreGui

local FireButton = Instance.new("TextButton")
FireButton.Size = UDim2.new(0,100,0,100)
FireButton.Position = UDim2.new(0.85,0,0.75,0)
FireButton.Text = "ยิง"
FireButton.BackgroundColor3 = Color3.fromRGB(200,50,50)
FireButton.TextColor3 = Color3.fromRGB(255,255,255)
FireButton.Font = Enum.Font.SourceSansBold
FireButton.TextSize = 28
FireButton.Active = true
FireButton.Draggable = true
FireButton.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(1,0) -- วงกลม
UICorner.Parent = FireButton

-- ตัวแปรคูลดาวน์
local canShoot = true
local killAuraConnection
-- ฟังก์ชันหาผู้เล่นใกล้สุด
local function FindNearestPlayer(radius)
    radius = radius or 50
    local nearest, shortest
    shortest = radius
    local myPos = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart.Position
    if not myPos then return nil end
    for _,plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local dist = (plr.Character.HumanoidRootPart.Position - myPos).Magnitude
            if dist < shortest then
                shortest = dist
                nearest = plr
            end
        end
    end
    return nearest
end

-- ฟังก์ชันยิง
local function ShootAdvanced(target)
    if not target or not target.Character or not LocalPlayer.Character then return end
    local hrp = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local part = target.Character:FindFirstChild("Head")
    if not part then return end

    local backpack = LocalPlayer:FindFirstChild("Backpack")
    if not backpack then return end
    local guns = {}
    for _, child in ipairs(backpack:GetChildren()) do
        if child.Name == "Gun" and child:FindFirstChild("shot") then
            table.insert(guns, child)
        end
    end

    local targetPos = part.Position
    local targetVel = part.Velocity or Vector3.new(0,0,0)
    local distance = (targetPos - hrp.Position).Magnitude
    local bulletSpeed = 300
    local travelTime = distance / bulletSpeed

    for _, gun in ipairs(guns) do
        pcall(function()
            gun.Parent = LocalPlayer.Character
            local predictedPos = targetPos + targetVel * travelTime
            gun.shot:FireServer(predictedPos)
            gun.Parent = backpack
        end)
    end
end

-- ตอนกดปุ่ม ยิง -> หยุดอนิเมชั่นเดิน/ยืน เล่นยิง + Kill Aura 0.5 วิ
FireButton.MouseButton1Click:Connect(function()
    if not canShoot then return end
    canShoot = false
    FireButton.Text = "⏳"

    isShooting = true
    walkTrack:Stop()
    idleTrack:Stop()

    -- เล่นอนิเมชั่นยิง
    shootTrack:Play()

    -- เปิด Kill Aura 0.5 วิ
    killAuraConnection = RunService.Heartbeat:Connect(function()
        local nearest = FindNearestPlayer(50)
        if nearest then
            ShootAdvanced(nearest)
        end
    end)
    task.delay(0.5, function()
        if killAuraConnection then
            killAuraConnection:Disconnect()
            killAuraConnection = nil
        end
    end)

    -- รอจนอนิเมชั่นยิงจบ
    shootTrack.Stopped:Wait()
    isShooting = false
    updateAnim()

    -- คูลดาวน์ 1 วิ
    task.delay(1, function()
        canShoot = true
        FireButton.Text = "ยิง"
    end)
end)
